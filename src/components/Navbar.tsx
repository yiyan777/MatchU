"use client";

import Link from "next/link";
import { useEffect, useState, useRef } from "react";
import { auth } from "@/lib/firebase";
import { onAuthStateChanged, signOut } from "firebase/auth";
import { useRouter } from "next/navigation";
import { usePathname } from "next/navigation";
import { collection, getDocs, query, where } from "firebase/firestore";
import { db } from "@/lib/firebase";
import { useHasMatch } from "@/hooks/useHasMatch";

export default function Navbar({ 
  hasMatch = false,
  partner,
}: {
  hasMatch?: boolean;
  partner?: {name:string; avatarUrl: string } | null;
}) {
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const router = useRouter();
    const pathname = usePathname();
    const [menuOpen, setMenuOpen] = useState(false);
    const menuRef = useRef<HTMLDivElement>(null);

    useEffect(()=> {
      const unsubscribe = onAuthStateChanged(auth, (user) => {
        setIsLoggedIn(!!user); // 有登入就 true, 沒登入就 false
      });

      return () => unsubscribe();
    }, []);

    useEffect(() => {
      const handleClickOutside = (e: MouseEvent) => {
        if (menuRef.current && !menuRef.current.contains(e.target as Node)) {
          setMenuOpen(false);
        }
      };
      document.addEventListener("mousedown", handleClickOutside);
      return () => document.removeEventListener("mousedown", handleClickOutside);
    }, []);

    const handleLogout = async () => {
      await signOut(auth);
      setTimeout(() => {
        router.push("/");
      }, 300);
    };

    const buttons = (
      <>
          {isLoggedIn && hasMatch &&(
            <button
              className="
                text-sm rounded-full px-4 py-2 text-white cursor-pointer 
                bg-gradient-to-l from-purple-500 to-pink-300
                transition duration-300 ease-in-out
                hover:brightness-110"
                onClick={() => router.push("/chat")}
            >
              聊天列表
            </button>
          )}

          {isLoggedIn && (pathname === "/" || pathname === "/explore" || pathname === "/chat") && (
            <button className="
                text-sm rounded-full px-4 py-2 text-white cursor-pointer
                bg-gradient-to-l from-purple-500 to-pink-300
                transition duration-300 ease-in-out
                hover:brightness-110"
                onClick= {()=> router.push("/profile")}
                >
                  我的主頁
            </button>
          )}

          {isLoggedIn ? (
            <button
              onClick={handleLogout} 
              className="
                  text-sm rounded-full px-4 py-2 text-white cursor-pointer
                  bg-gradient-to-l from-purple-500 to-pink-300
                  transition duration-300 ease-in-out
                  hover:brightness-110"
            >
              登出
            </button>
          ) : (
            <button
              onClick={() => router.push("/login")}
              className="
                  text-sm rounded-full px-4 py-2 text-white cursor-pointer
                  bg-gradient-to-l from-purple-500 to-pink-300
                  transition duration-300 ease-in-out
                  hover:brightness-110"
            >
              登入 / 註冊
            </button>
          )}
      </>
    );


    return (
      <nav className="flex justify-between items-center mb-1 sm:px-4 fixed top-0 left-0 right-0 
        bg-white w-full h-[80px] z-50 border-b-1 border-gray-200">
        <Link href="/" className="cursor-pointer flex flex-col items-center justify-center">
          <svg 
            className="w-20 h-12 text-purple-500 fill-current"
            viewBox="-490 30 1000 300"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path d="M0 0 C3.41878926 2.91454305 6.73487735 5.91471199 10 9 C10.61488281 9.57363281 11.22976562 10.14726563 11.86328125 10.73828125 C16.15872987 14.87573636 19.88668065 19.41126743 23.6171875 24.05859375 C25.19886019 26.01105201 26.80833127 27.94133146 28.4453125 29.84765625 C35.00914386 37.49174199 40.6456695 45.47630883 46 54 C46.40718262 54.64533691 46.81436523 55.29067383 47.23388672 55.95556641 C82.45963456 112.33632505 116.35726232 205.1301876 115 272 C132.74891975 259.20538576 147.70990948 242.73513093 161.29345703 225.72290039 C169.72568932 215.23405706 169.72568932 215.23405706 174.0625 214.4375 C177 215 177 215 179.375 216.5625 C181.6093721 219.91405815 181.33864878 222.0191757 181 226 C175.39248886 237.97531183 164.17415962 247.25276566 154.875 256.3125 C152.57945345 258.5651957 150.28690677 260.82086451 147.99685669 263.07914734 C146.58369364 264.47101448 145.1670175 265.85932817 143.74606323 267.24324036 C139.82145323 271.08957669 136.11852287 275.05032884 132.54983521 279.22990417 C131.09383663 280.89282743 129.5813772 282.45684032 128 284 C128.56203125 283.855625 129.1240625 283.71125 129.703125 283.5625 C136.18182382 282.13162173 142.51502844 281.75112801 149.125 281.6875 C149.9593457 281.67009766 150.79369141 281.65269531 151.65332031 281.63476562 C158.67761882 281.64029875 164.75905297 283.05543178 170.8125 286.6875 C175.14488453 291.26744936 177.22745724 295.78552763 177.4375 302.125 C177.12157003 309.01227328 174.00343049 314.32313373 169 319 C150.33939922 333.5651769 126.6234362 335.38287482 103.9296875 337.22949219 C85.03184722 338.08152967 85.03184722 338.08152967 69 347 C67.44109935 349.36711298 66.27585684 351.39672255 65.125 353.9375 C64.80112305 354.61409668 64.47724609 355.29069336 64.14355469 355.98779297 C60.84756187 363.01412209 57.9620969 370.23127364 55.14501953 377.46069336 C53.20416643 382.37855753 51.36249325 386.88430826 48 391 C44.5 391.625 44.5 391.625 41 391 C38.63502561 389.13291495 37.33969285 387.67938569 36 385 C36.3153711 377.23398671 38.67668208 370.75190864 41.5 363.5625 C41.91636719 362.47517578 42.33273438 361.38785156 42.76171875 360.26757812 C45.74513561 352.50972877 45.74513561 352.50972877 47 350 C46.35562988 350.11593506 45.71125977 350.23187012 45.04736328 350.35131836 C42.07393196 350.8839805 39.09948729 351.41076788 36.125 351.9375 C35.11179688 352.11990234 34.09859375 352.30230469 33.0546875 352.49023438 C6.97403354 357.08778555 -22.27702772 357.60805676 -48 351 C-48.87624023 350.78037598 -49.75248047 350.56075195 -50.65527344 350.33447266 C-69.17656802 345.56751651 -87.69150204 338.43623664 -98.50390625 321.66015625 C-106.69278701 307.09977036 -108.99994779 292.35200431 -104.54418945 276.15014648 C-100.4038095 262.32944156 -93.63157883 250.73418382 -84 240 C-83.15179688 239.04351562 -82.30359375 238.08703125 -81.4296875 237.1015625 C-79.30155193 234.71991862 -77.15572462 232.3566082 -75 230 C-75.36134033 229.34443115 -75.72268066 228.6888623 -76.0949707 228.01342773 C-107.35259765 171.0420173 -136.30253341 96.8885498 -117.8125 31.1875 C-112.20054518 12.72369048 -102.23507716 -4.35958898 -85.42578125 -14.5625 C-56.80441871 -29.65948244 -23.77120309 -19.50268984 0 0 Z M-86.375 6.5625 C-103.66344655 25.81301864 -107.61989218 54.10582535 -107 79 C-103.83933179 126.06114524 -87.61712383 175.76493676 -63 216 C-61.99966568 217.66646603 -60.99955181 219.3330645 -60 221 C-56.20948478 220.52241519 -52.53442573 219.92564486 -48.8203125 219.02734375 C-39.16575547 216.74411553 -29.93395044 215.61978181 -20 215.625 C-18.98695801 215.62363037 -17.97391602 215.62226074 -16.93017578 215.62084961 C-1.96788461 215.83689836 13.41624891 218.83841241 25 229 C30.71549753 235.72339172 33.52365284 242.81814858 33.23828125 251.6796875 C32.35484486 260.28233041 28.51112215 266.35928827 22 272 C11.7178082 278.3047899 -1.28556582 278.28703123 -12.88671875 276.3515625 C-31.51745739 271.79608409 -51.13373941 260.29939089 -62 244 C-74.83756991 249.43127958 -81.76696929 263.90034698 -87 276 C-90.96166153 286.48014007 -91.64540217 296.93506976 -87.3125 307.40625 C-81.89706193 318.10818713 -72.37975892 326.03947391 -61.08984375 330.0703125 C-31.2407969 339.05144164 0.25011329 342.95957581 31 336 C31.65419922 335.85546387 32.30839844 335.71092773 32.98242188 335.56201172 C60.37574536 329.33437549 83.81554898 315.39705484 105.875 298.3984375 C107.86897499 296.86806169 109.90859125 295.3942725 112 294 C112 293.34 112 292.68 112 292 C111.45730469 291.78085937 110.91460937 291.56171875 110.35546875 291.3359375 C109.64003906 291.01882813 108.92460937 290.70171875 108.1875 290.375 C107.12595703 289.92253906 107.12595703 289.92253906 106.04296875 289.4609375 C102.28214129 286.77155037 101.17880088 282.84810866 100.25146484 278.44946289 C100.0615065 277.12522712 99.88188657 275.79947988 99.7109375 274.47265625 C99.49523137 272.96344377 99.2788079 271.45433369 99.06176758 269.9453125 C98.8954332 268.75470215 98.8954332 268.75470215 98.72573853 267.54003906 C87.72620902 189.84180508 63.46504261 97.94134455 -12.61328125 10.78125 C-34.49948591 -5.40350639 -64.1518369 -13.77956859 -86.375 6.5625 Z M-48 235 C-40.32881945 248.34118357 -24.39741057 257.15200259 -9.9375 261.3125 C-2.18599647 262.66593712 4.93616329 262.86634942 12 259 C15.42887276 256.09864612 16.82305665 254.28915867 17.4375 249.8125 C16.84378412 244.63869022 14.94647674 242.28742297 11 239 C5.06296135 235.19266049 -1.05915112 233.05461661 -8 232 C-8.72960937 231.88914062 -9.45921875 231.77828125 -10.2109375 231.6640625 C-22.8423021 230.02420113 -35.88002286 230.96000762 -48 235 Z M105 320 C113.02273571 320.55288475 120.29774525 319.11305455 128.07739258 317.22900391 C130.05941943 316.75074334 132.04557052 316.29417378 134.03320312 315.83984375 C143.65367468 313.56194872 152.92739477 311.25395408 160 304 C160 302.68 160 301.36 160 300 C140.70994429 291.65835429 118.14387576 306.72062036 105 320 Z "
            fill="currentColor" 
            transform="translate(-212,71)"
            />
            <path d="M0 0 C3.41878926 2.91454305 6.73487735 5.91471199 10 9 C10.61488281 9.57363281 11.22976562 10.14726563 11.86328125 10.73828125 C16.15872987 14.87573636 19.88668065 19.41126743 23.6171875 24.05859375 C25.19886019 26.01105201 26.80833127 27.94133146 28.4453125 29.84765625 C35.00914386 37.49174199 40.6456695 45.47630883 46 54 C46.40718262 54.64533691 46.81436523 55.29067383 47.23388672 55.95556641 C82.45963456 112.33632505 116.35726232 205.1301876 115 272 C132.74891975 259.20538576 147.70990948 242.73513093 161.29345703 225.72290039 C169.72568932 215.23405706 169.72568932 215.23405706 174.0625 214.4375 C177 215 177 215 179.375 216.5625 C181.6093721 219.91405815 181.33864878 222.0191757 181 226 C175.39248886 237.97531183 164.17415962 247.25276566 154.875 256.3125 C152.57945345 258.5651957 150.28690677 260.82086451 147.99685669 263.07914734 C146.58369364 264.47101448 145.1670175 265.85932817 143.74606323 267.24324036 C139.82145323 271.08957669 136.11852287 275.05032884 132.54983521 279.22990417 C131.09383663 280.89282743 129.5813772 282.45684032 128 284 C128.56203125 283.855625 129.1240625 283.71125 129.703125 283.5625 C136.18182382 282.13162173 142.51502844 281.75112801 149.125 281.6875 C149.9593457 281.67009766 150.79369141 281.65269531 151.65332031 281.63476562 C158.67761882 281.64029875 164.75905297 283.05543178 170.8125 286.6875 C175.14488453 291.26744936 177.22745724 295.78552763 177.4375 302.125 C177.12157003 309.01227328 174.00343049 314.32313373 169 319 C150.33939922 333.5651769 126.6234362 335.38287482 103.9296875 337.22949219 C85.03184722 338.08152967 85.03184722 338.08152967 69 347 C67.44109935 349.36711298 66.27585684 351.39672255 65.125 353.9375 C64.80112305 354.61409668 64.47724609 355.29069336 64.14355469 355.98779297 C60.84756187 363.01412209 57.9620969 370.23127364 55.14501953 377.46069336 C53.20416643 382.37855753 51.36249325 386.88430826 48 391 C44.5 391.625 44.5 391.625 41 391 C38.63502561 389.13291495 37.33969285 387.67938569 36 385 C36.3153711 377.23398671 38.67668208 370.75190864 41.5 363.5625 C41.91636719 362.47517578 42.33273438 361.38785156 42.76171875 360.26757812 C45.74513561 352.50972877 45.74513561 352.50972877 47 350 C46.35562988 350.11593506 45.71125977 350.23187012 45.04736328 350.35131836 C42.07393196 350.8839805 39.09948729 351.41076788 36.125 351.9375 C35.11179688 352.11990234 34.09859375 352.30230469 33.0546875 352.49023438 C6.97403354 357.08778555 -22.27702772 357.60805676 -48 351 C-48.87624023 350.78037598 -49.75248047 350.56075195 -50.65527344 350.33447266 C-69.17656802 345.56751651 -87.69150204 338.43623664 -98.50390625 321.66015625 C-106.69278701 307.09977036 -108.99994779 292.35200431 -104.54418945 276.15014648 C-100.4038095 262.32944156 -93.63157883 250.73418382 -84 240 C-83.15179688 239.04351562 -82.30359375 238.08703125 -81.4296875 237.1015625 C-79.30155193 234.71991862 -77.15572462 232.3566082 -75 230 C-75.36134033 229.34443115 -75.72268066 228.6888623 -76.0949707 228.01342773 C-107.35259765 171.0420173 -136.30253341 96.8885498 -117.8125 31.1875 C-112.20054518 12.72369048 -102.23507716 -4.35958898 -85.42578125 -14.5625 C-56.80441871 -29.65948244 -23.77120309 -19.50268984 0 0 Z M-86.375 6.5625 C-103.66344655 25.81301864 -107.61989218 54.10582535 -107 79 C-103.83933179 126.06114524 -87.61712383 175.76493676 -63 216 C-61.99966568 217.66646603 -60.99955181 219.3330645 -60 221 C-56.20948478 220.52241519 -52.53442573 219.92564486 -48.8203125 219.02734375 C-39.16575547 216.74411553 -29.93395044 215.61978181 -20 215.625 C-18.98695801 215.62363037 -17.97391602 215.62226074 -16.93017578 215.62084961 C-1.96788461 215.83689836 13.41624891 218.83841241 25 229 C30.71549753 235.72339172 33.52365284 242.81814858 33.23828125 251.6796875 C32.35484486 260.28233041 28.51112215 266.35928827 22 272 C11.7178082 278.3047899 -1.28556582 278.28703123 -12.88671875 276.3515625 C-31.51745739 271.79608409 -51.13373941 260.29939089 -62 244 C-74.83756991 249.43127958 -81.76696929 263.90034698 -87 276 C-90.96166153 286.48014007 -91.64540217 296.93506976 -87.3125 307.40625 C-81.89706193 318.10818713 -72.37975892 326.03947391 -61.08984375 330.0703125 C-31.2407969 339.05144164 0.25011329 342.95957581 31 336 C31.65419922 335.85546387 32.30839844 335.71092773 32.98242188 335.56201172 C60.37574536 329.33437549 83.81554898 315.39705484 105.875 298.3984375 C107.86897499 296.86806169 109.90859125 295.3942725 112 294 C112 293.34 112 292.68 112 292 C111.45730469 291.78085937 110.91460937 291.56171875 110.35546875 291.3359375 C109.64003906 291.01882813 108.92460937 290.70171875 108.1875 290.375 C107.12595703 289.92253906 107.12595703 289.92253906 106.04296875 289.4609375 C102.28214129 286.77155037 101.17880088 282.84810866 100.25146484 278.44946289 C100.0615065 277.12522712 99.88188657 275.79947988 99.7109375 274.47265625 C99.49523137 272.96344377 99.2788079 271.45433369 99.06176758 269.9453125 C98.8954332 268.75470215 98.8954332 268.75470215 98.72573853 267.54003906 C87.72620902 189.84180508 63.46504261 97.94134455 -12.61328125 10.78125 C-34.49948591 -5.40350639 -64.1518369 -13.77956859 -86.375 6.5625 Z M-48 235 C-40.32881945 248.34118357 -24.39741057 257.15200259 -9.9375 261.3125 C-2.18599647 262.66593712 4.93616329 262.86634942 12 259 C15.42887276 256.09864612 16.82305665 254.28915867 17.4375 249.8125 C16.84378412 244.63869022 14.94647674 242.28742297 11 239 C5.06296135 235.19266049 -1.05915112 233.05461661 -8 232 C-8.72960937 231.88914062 -9.45921875 231.77828125 -10.2109375 231.6640625 C-22.8423021 230.02420113 -35.88002286 230.96000762 -48 235 Z M105 320 C113.02273571 320.55288475 120.29774525 319.11305455 128.07739258 317.22900391 C130.05941943 316.75074334 132.04557052 316.29417378 134.03320312 315.83984375 C143.65367468 313.56194872 152.92739477 311.25395408 160 304 C160 302.68 160 301.36 160 300 C140.70994429 291.65835429 118.14387576 306.72062036 105 320 Z "
            fill="currentColor" 
            transform="translate(212,71) scale(-1,1)"
            />
          </svg>
          <div className="text-purple-600 text-md title pr-[2px]">MatchU</div>
        </Link>

        {partner && (
          <div className="flex items-center gap-2">
            <img
              src={partner.avatarUrl}
              alt="對方頭像"
              className="w-15 h-15 rounded-full object-cover sm:ml-[97px]"
            />
            <div className="text-sm font-semibold text-gray-800">{partner.name}</div>
          </div>
        )}
        
        {/* 桌機版按鈕 */}
        <div className="hidden sm:flex gap-1">
          {buttons}
        </div>

        {/* 手機版漢堡圖 */}
        <div className="sm:hidden relative" ref={menuRef}>
          <button
            onClick={() => setMenuOpen(!menuOpen)}
            className="text-gray-700 focus:outline-none cursor-pointer mr-5"
          >
            {/* 漢堡圖 */}
            <svg className="w-6 h-6 text-purple-700 mt-[10px]" fill="none" stroke="currentColor" strokeWidth={2} viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          {/* 下拉選單 */}
          {menuOpen && (
            <div className="absolute right-0 mt-2 bg-white rounded-xl shadow z-50 flex flex-col gap-2 p-2 w-26">
              {buttons}
            </div>
          )}
        </div>
      </nav>
    );
}